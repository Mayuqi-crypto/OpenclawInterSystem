<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OIS - OpenClaw Inter-System</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a2e; color: #eee; height: 100vh; display: flex; flex-direction: column; }
    header { background: #16213e; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
    header h1 { font-size: 1.5rem; }
    header h1 span { color: #e94560; }
    .header-right { display: flex; align-items: center; gap: 1rem; }
    .user-info { color: #888; font-size: 0.9rem; }
    .tabs { display: flex; gap: 0.5rem; }
    .tab { background: transparent; border: none; color: #888; padding: 0.5rem 1rem; cursor: pointer; font-size: 1rem; border-radius: 4px; }
    .tab.active { background: #e94560; color: white; }
    main { flex: 1; display: flex; overflow: hidden; }
    
    /* ËÅäÂ§© */
    #chat-panel { flex: 1; display: flex; flex-direction: column; padding: 1rem; }
    #messages { flex: 1; overflow-y: auto; padding: 1rem; background: #0f0f23; border-radius: 8px; margin-bottom: 1rem; }
    .msg { margin-bottom: 0.75rem; padding: 0.5rem; background: #16213e; border-radius: 6px; }
    .msg.archive { opacity: 0.7; border-left: 3px solid #444; }
    .msg .meta { font-size: 0.8rem; color: #888; margin-bottom: 0.25rem; }
    .msg .meta .user { color: #e94560; font-weight: bold; }
    .msg .text { word-wrap: break-word; white-space: pre-wrap; }
    #chat-input { display: flex; gap: 0.5rem; }
    #chat-input input { flex: 1; padding: 0.75rem; border: none; border-radius: 6px; background: #16213e; color: white; font-size: 1rem; }
    #chat-input button { padding: 0.75rem 1.5rem; background: #e94560; border: none; border-radius: 6px; color: white; cursor: pointer; }
    
    /* Êñá‰ª∂ */
    #files-panel { flex: 1; display: none; flex-direction: column; padding: 1rem; }
    #files-panel.active { display: flex; }
    #chat-panel.active { display: flex; }
    #chat-panel:not(.active) { display: none; }
    .breadcrumb { background: #16213e; padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem; }
    .breadcrumb a { color: #e94560; text-decoration: none; cursor: pointer; }
    .file-list { flex: 1; overflow-y: auto; background: #0f0f23; border-radius: 8px; }
    .file-item { padding: 0.75rem 1rem; border-bottom: 1px solid #1a1a2e; display: flex; align-items: center; cursor: pointer; }
    .file-item:hover { background: #16213e; }
    .file-item .icon { margin-right: 0.75rem; font-size: 1.2rem; }
    .file-item .name { flex: 1; }
    
    /* ÁºñËæëÂô® */
    #editor-panel { flex: 1; display: none; flex-direction: column; padding: 1rem; }
    #editor-panel.active { display: flex; }
    #editor-header { display: flex; justify-content: space-between; margin-bottom: 1rem; }
    #editor-path { color: #888; }
    #editor-actions button { margin-left: 0.5rem; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; }
    #editor-save { background: #e94560; color: white; }
    #editor-close { background: #333; color: white; }
    #editor-content { flex: 1; width: 100%; background: #0f0f23; color: #eee; border: none; border-radius: 8px; padding: 1rem; font-family: monospace; font-size: 14px; resize: none; }
    
    /* ÁôªÂΩï */
    #login-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 100; }
    #login-modal.hidden { display: none; }
    #login-modal .modal { background: #16213e; padding: 2rem; border-radius: 12px; text-align: center; min-width: 300px; }
    #login-modal h2 { margin-bottom: 1rem; }
    #login-modal input { display: block; width: 100%; margin: 0.75rem 0; padding: 0.75rem; border: none; border-radius: 6px; font-size: 1rem; }
    #login-modal button { padding: 0.75rem 2rem; background: #e94560; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 1rem; width: 100%; margin-top: 0.5rem; }
    #login-modal .error { color: #e94560; margin-top: 0.5rem; }
  </style>
</head>
<body>
  <header>
    <h1>üêæ <span>OIS</span> - OpenClaw Inter-System</h1>
    <div class="header-right">
      <span class="user-info" id="user-display"></span>
      <div class="tabs">
        <button class="tab active" data-panel="chat">üí¨ Áæ§ËÅä</button>
        <button class="tab" data-panel="files">üìÅ Êñá‰ª∂</button>
      </div>
    </div>
  </header>
  
  <main>
    <div id="chat-panel" class="active">
      <div id="messages"></div>
      <div id="chat-input">
        <input type="text" id="msg-input" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." autocomplete="off">
        <button onclick="sendMessage()">ÂèëÈÄÅ</button>
      </div>
    </div>
    
    <div id="files-panel">
      <div class="breadcrumb" id="breadcrumb"></div>
      <div class="file-list" id="file-list"></div>
    </div>
    
    <div id="editor-panel">
      <div id="editor-header">
        <span id="editor-path"></span>
        <div id="editor-actions">
          <button id="editor-save" onclick="saveFile()">‰øùÂ≠ò</button>
          <button id="editor-close" onclick="closeEditor()">ÂÖ≥Èó≠</button>
        </div>
      </div>
      <textarea id="editor-content"></textarea>
    </div>
  </main>
  
  <div id="login-modal">
    <div class="modal">
      <h2>üêæ OIS ÁôªÂΩï</h2>
      <p>CloudMaids ÂÜÖÈÉ®Á≥ªÁªü</p>
      <input type="text" id="login-username" placeholder="Áî®Êà∑Âêç">
      <input type="password" id="login-password" placeholder="ÂØÜÁ†Å">
      <button onclick="login()">ÁôªÂΩï</button>
      <div class="error" id="login-error"></div>
    </div>
  </div>

  <script>
    let ws;
    let token = localStorage.getItem('ois-token');
    let username = localStorage.getItem('ois-username');
    let currentPath = '';
    let currentFile = '';
    
    // È™åËØÅÂ∑≤Êúâ token
    if (token) {
      verifyToken();
    }
    
    async function verifyToken() {
      try {
        const res = await fetch('/api/verify', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (res.ok) {
          const data = await res.json();
          username = data.user;
          document.getElementById('login-modal').classList.add('hidden');
          document.getElementById('user-display').textContent = `üë§ ${username}`;
          connect();
        } else {
          localStorage.removeItem('ois-token');
          token = null;
        }
      } catch (e) {
        console.error(e);
      }
    }
    
    async function login() {
      const user = document.getElementById('login-username').value.trim();
      const pass = document.getElementById('login-password').value;
      
      if (!user || !pass) {
        document.getElementById('login-error').textContent = 'ËØ∑Â°´ÂÜôÁî®Êà∑ÂêçÂíåÂØÜÁ†Å';
        return;
      }
      
      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: user, password: pass })
        });
        
        if (res.ok) {
          const data = await res.json();
          token = data.token;
          username = data.user;
          localStorage.setItem('ois-token', token);
          localStorage.setItem('ois-username', username);
          document.getElementById('login-modal').classList.add('hidden');
          document.getElementById('user-display').textContent = `üë§ ${username}`;
          connect();
        } else {
          document.getElementById('login-error').textContent = 'ÂØÜÁ†ÅÈîôËØØ';
        }
      } catch (e) {
        document.getElementById('login-error').textContent = 'ËøûÊé•Â§±Ë¥•';
      }
    }
    
    document.getElementById('login-password').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') login();
    });
    
    // WebSocket
    function connect() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${location.host}`);
      
      ws.onopen = () => {
        ws.send(JSON.stringify({ type: 'auth', token }));
      };
      
      ws.onmessage = (e) => {
        const data = JSON.parse(e.data);
        if (data.type === 'history') {
          document.getElementById('messages').innerHTML = '';
          data.messages.forEach(addMessage);
        } else if (data.type === 'message') {
          addMessage(data.message);
        } else if (data.type === 'auth_fail') {
          localStorage.removeItem('ois-token');
          location.reload();
        }
      };
      
      ws.onclose = () => setTimeout(connect, 3000);
    }
    
    function addMessage(msg) {
      const el = document.createElement('div');
      el.className = 'msg' + (msg.fromArchive ? ' archive' : '');
      const time = new Date(msg.time).toLocaleString('zh-CN', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
      let textHtml = escapeHtml(msg.text);
    // È´ò‰∫Æ @ÊèêÂèä
    textHtml = textHtml.replace(/@(HKH|ARIA|Mikasa|all|ÊâÄÊúâ‰∫∫)/gi, '<span style="background:#e94560;padding:0 4px;border-radius:3px;color:white">@$1</span>');
    el.innerHTML = `<div class="meta"><span class="user">${escapeHtml(msg.user)}</span> ¬∑ ${time}</div><div class="text">${textHtml}</div>`;
      document.getElementById('messages').appendChild(el);
      document.getElementById('messages').scrollTop = 999999;
    }
    
    function sendMessage() {
      const input = document.getElementById('msg-input');
      const text = input.value.trim();
      if (text && ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'chat', text }));
        input.value = '';
      }
    }
    
    document.getElementById('msg-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
    
    // Tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const panel = tab.dataset.panel;
        document.getElementById('chat-panel').classList.toggle('active', panel === 'chat');
        document.getElementById('files-panel').classList.toggle('active', panel === 'files');
        document.getElementById('editor-panel').classList.remove('active');
        if (panel === 'files') loadFiles('');
      });
    });
    
    // Êñá‰ª∂ÁÆ°ÁêÜ
    async function loadFiles(path) {
      currentPath = path;
      const res = await fetch(`/api/files?path=${encodeURIComponent(path)}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      
      const parts = path.split('/').filter(Boolean);
      let bc = '<a onclick="loadFiles(\'\')">üìÅ Ê†πÁõÆÂΩï</a>';
      let acc = '';
      parts.forEach(p => {
        acc += '/' + p;
        bc += ` / <a onclick="loadFiles('${acc}')">${p}</a>`;
      });
      document.getElementById('breadcrumb').innerHTML = bc;
      
      let html = '';
      if (path) {
        const parent = parts.slice(0, -1).join('/');
        html += `<div class="file-item" onclick="loadFiles('${parent}')"><span class="icon">‚¨ÜÔ∏è</span><span class="name">..</span></div>`;
      }
      data.items.forEach(item => {
        const icon = item.isDir ? 'üìÅ' : 'üìÑ';
        if (item.isDir) {
          html += `<div class="file-item" onclick="loadFiles('${item.path}')"><span class="icon">${icon}</span><span class="name">${item.name}</span></div>`;
        } else {
          html += `<div class="file-item" onclick="openFile('${item.path}')"><span class="icon">${icon}</span><span class="name">${item.name}</span></div>`;
        }
      });
      document.getElementById('file-list').innerHTML = html;
    }
    
    async function openFile(path) {
      const res = await fetch(`/api/file?path=${encodeURIComponent(path)}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      currentFile = path;
      document.getElementById('editor-path').textContent = path;
      document.getElementById('editor-content').value = data.content;
      document.getElementById('files-panel').classList.remove('active');
      document.getElementById('editor-panel').classList.add('active');
    }
    
    async function saveFile() {
      const content = document.getElementById('editor-content').value;
      await fetch('/api/file', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ path: currentFile, content })
      });
      alert('Â∑≤‰øùÂ≠ò!');
    }
    
    function closeEditor() {
      document.getElementById('editor-panel').classList.remove('active');
      document.getElementById('files-panel').classList.add('active');
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
